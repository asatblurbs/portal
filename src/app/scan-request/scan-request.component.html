<app-header-new></app-header-new>
<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <mdb-card class="my-3">
        <mdb-card-header class="centurionBlue h5 text-white">Scan Request</mdb-card-header>
        <mdb-card-body>
          <mdb-stepper #stepper [linear]="true" (stepChange)="handleStepChange()" [vertical]="flagVerticalStepper">
            <mdb-step name="Scan" label="Type" [stepForm]="myRequestForm">
              <form [formGroup]="myRequestForm">
                <mdb-card-text>Please select the Type of Scan</mdb-card-text>
                <div class="card-deck">
                  <mdb-card class="m-3" (click)="updateScanType('source_code')">
                    <mdb-card-header class="custom-control custom-radio">
                      <span class="ml-3">&nbsp;</span>
                      <input type="radio" class="custom-control-input" id="typeSourceCode" name="scanType"
                             value="source_code" formControlName="scanType">
                      <label for="typeSourceCode" class="custom-control-label">Source Code</label>
                    </mdb-card-header>
                    <mdb-card-body style="height:200px">
                      <mdb-card-text>
                        Analyze the source code for security and quality issues
                      </mdb-card-text>
                    </mdb-card-body>
                  </mdb-card>
                  <mdb-card class="m-3" (click)="updateScanType('mobile_app')">
                    <mdb-card-header class="custom-control custom-radio">
                      <span class="ml-3">&nbsp;</span>
                      <input type="radio" class="custom-control-input" id="typeMobileApp" name="scanType"
                             value="mobile_app" formControlName="scanType">
                      <label for="typeMobileApp" class="custom-control-label">Binary Application</label>
                    </mdb-card-header>
                    <mdb-card-body>
                      <mdb-card-text>
                        Analyzing the Mobile Application, Firmware or executables to identify the security vulnerabilities and
                        licensing term of open source components in the application
                      </mdb-card-text>
                    </mdb-card-body>
                  </mdb-card>
                  <mdb-card class="m-3" (click)="updateScanType('web_app')">
                    <mdb-card-header class="custom-control custom-radio">
                      <span class="ml-3">&nbsp;</span>
                      <input type="radio" class="custom-control-input" id="typeWebApp" name="scanType"
                             value="web_app" formControlName="scanType">
                      <label for="typeWebApp" class="custom-control-label">Web Application</label>
                    </mdb-card-header>
                    <mdb-card-body>
                      <mdb-card-text>
                        Perform dynamic analysis on the web portal. The testing is intrusive, so it is recommended not
                        to perform on a production system
                      </mdb-card-text>
                    </mdb-card-body>
                  </mdb-card>
                </div>
              </form>
            </mdb-step>
            <mdb-step name="Scan" label="Item" [stepForm]="myRequestForm">
              <form [formGroup]="myRequestForm">
                <mdb-card-text>Please specify how to provide the scanning item to Centurion platform</mdb-card-text>
                <div class="card-deck">
                  <mdb-card class="m-3" *ngIf="flagShowRepo" (click)="updateDeliveryMethod('repo')">
                    <mdb-card-header class="custom-control custom-radio">
                      <span class="ml-3">&nbsp;</span>
                      <input type="radio" class="custom-control-input" id="typeRepo" name="type" value="repo" formControlName="type">
                      <label for="typeRepo" class="custom-control-label">GIT Repository</label>
                    </mdb-card-header>
                    <mdb-card-body class="py-0">
                      <div class="md-form md-outline">
                        <input type="text" id="inputRepoURL" class="form-control" formControlName="repoURL" mdbInput>
                        <label for="inputRepoURL">Source Code Repository</label>
                      </div>
                      <div class="md-form md-outline">
                        <mdb-select [options]="tempAccessToken" placeholder="Select an Access Token"
                                    formControlName="tokenId"
                                    outline="true" label="Access Token"></mdb-select>
                        <button mdbBtn color="link" class="p-0 text-blue"
                                data-toggle="modal" data-target="#basicExample"
                                (click)="tokenModal.show()" >Click here to add new Access Token</button>
                      </div>
                    </mdb-card-body>
                  </mdb-card>

                  <mdb-card class="m-3" *ngIf="flagShowUpload" (click)="updateDeliveryMethod('file')">
                    <mdb-card-header class="custom-control custom-radio" *ngIf="flagShowRepo; else elseUploadTitle">
                      <span class="ml-3">&nbsp;</span>
                      <input type="radio" class="custom-control-input" id="typeUpload" name="type" value="file" formControlName="type">
                      <label for="typeUpload" class="custom-control-label">Upload</label>
                    </mdb-card-header>
                    <ng-template #elseUploadTitle><mdb-card-header>Upload</mdb-card-header></ng-template>

                    <!-- Remarks: We had to switch from *ngIf/template to hidden approach
                    because the mdb-file-upload seems to revert to default view if we
                    use the *ngIf/template approach.
                     -->
                    <mdb-card-body class="p-0" [hidden]="flagUpload">
                      <mdb-file-upload (fileRemoved)="onFileRemove()" (fileAdded)="onFileAdd($event)" ></mdb-file-upload>
                    </mdb-card-body>
                    <mdb-card-body [hidden]="!flagUpload" style="height: 200px">
                      <mdb-progress [value]="progressUploadCount"
                                    min="0" max="100" type="success"
                                    aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                      </mdb-progress>
                      <mdb-card-text *ngIf="progressUploadCount < 100">Uploading file to server. Please wait ...</mdb-card-text>
                      <mdb-card-text *ngIf="progressUploadCount < 100">Progress: <strong>{{progressUploadCount}} %</strong></mdb-card-text>
                      <mdb-card-text *ngIf="progressUploadCount == 100">File successfully uploaded to server</mdb-card-text>
                    </mdb-card-body>
                  </mdb-card>

                  <mdb-card class="m-3" *ngIf="flagShowWeb">
                    <mdb-card-header>Web Configuration</mdb-card-header>
                    <mdb-card-body>
                      <p>This section will be updated in MILESTONE 3</p>
                    </mdb-card-body>
                  </mdb-card>
                </div>
              </form>
            </mdb-step>
            <mdb-step name="Validate" label="Content" [stepForm]="myRequestForm">
              <form [formGroup]="myRequestForm">
                <mdb-card-text>Please wait while we analysing your scan item (Progress: {{progressCount}})</mdb-card-text>
                <div class="progress">
                  <div class="progress-bar"
                       role="progressbar" [style.width]="progressCount"
                       aria-valuenow="10"
                       aria-valuemin="0"
                       aria-valuemax="100"></div>
                </div>
              </form>
            </mdb-step>
            <mdb-step name="Programming" label="Language" [stepForm]="myRequestForm">
              <form [formGroup]="myRequestForm">
                <mdb-card-text>Please specify the programming language used </mdb-card-text>
                <div class="md-form md-outline">
                  <mdb-select [options]="optProgLangList" placeholder="Select Programming Language"
                              formControlName="programLanguage" id="inputProgramLang"
                              outline="true" label="Programming Language"></mdb-select>
                </div>
                <div class="md-form md-outline">
                  <input type="text" id="inputBuildCmd" class="form-control" mdbInput formControlName="buildCommand">
                  <label for="inputBuildCmd">Build Command</label>
                </div>
              </form>
            </mdb-step>
            <mdb-step name="Optional" label="Services" [stepForm]="myRequestForm">
              <form [formGroup]="myRequestForm">
                <mdb-card-text>Please select optional services for this scan</mdb-card-text>
                <div class="custom-control custom-checkbox">
                  <mdb-checkbox [checked]="true">Security Vulnerability</mdb-checkbox>
                  <mdb-checkbox>Android</mdb-checkbox>
                  <mdb-checkbox>Web Application</mdb-checkbox>
                  <mdb-checkbox>Continuous Scan</mdb-checkbox>
                </div>

              </form>
            </mdb-step>
          </mdb-stepper>
        </mdb-card-body>
      </mdb-card>
    </div>
  </div>
  <div class="row">
    <div class="d-flex justify-content-center col-12">
      <button mdbBtn type="button" color="danger" rounded="true" outline="true" class="waves-light col-2"
                  mdbWavesEffect (click)="stepper.previous()">Back</button>
      <button mdbBtn type="button" rounded="true" class="waves-light centurionBlue col-2 text-white"
                  mdbWavesEffect (click)="stepper.next()" [hidden]="flagSubmit">Next</button>
      <button mdbBtn type="button" color="success" rounded="true" class="waves-light col-2 text-white"
                  mdbWavesEffect (click)="handleSubmit()" [hidden]="!flagSubmit">Submit</button>
    </div>
  </div>
</div>

<!-- Modal - Add Access Token -->
<div mdbModal #tokenModal class="modal fade left" id="frameModalTop" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Add Access Token</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="tokenModal.hide()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <form [formGroup]="myTokenForm">
          <div class="md-form md-outline">
            <input mdbValidate type="text" id="inputLabel" class="form-control" formControlName="label" mdbInput>
            <label for="inputLabel">Name</label>
            <mdb-error *ngIf="label.invalid && (label.dirty || label.touched)">Insufficient Length. Min 5 characters</mdb-error>
          </div>
          <div class="md-form md-outline">
            <input mdbValidate type="text" id="inputToken" class="form-control" formControlName="token" mdbInput>
            <label for="inputToken">Value</label>
            <mdb-error *ngIf="token.invalid && (token.dirty || token.touched)">Insufficient Length. Min 5 characters</mdb-error>
          </div>
        </form>
      </div>
      <div class="modal-footer d-flex justify-content-center">
        <button mdbBtn block="true" rounded="true" class="waves-light centurionOrange text-white"
                (click)="handleAddToken()"
                [disabled]="flagLoadingAddToken"
                mdbWavesEffect>
          <span *ngIf="!flagLoadingAddToken else loadingAddToken">Submit</span>
          <ng-template #loadingAddToken>
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          </ng-template>
        </button>
      </div>
    </div>
  </div>
</div>
